<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Tennis Board</title>
		<script src="./jquery-3.7.0.min.js"></script>
		<script src="./mqtt-4.3.7.min.js"></script>
		<script>
			$(function(){
				var START  = Date.now();
				var MATCH_TYPES = ["sd","us","au","rg","wb"];
				var CALLS = ["0","15","30","40","AD"];
				var current_set = 0;
				var current_game = 0;
				var tie_break = false;
				var game_over = false;
				var player_points = [0,0];
				var player_games = [0,0];
				var player_sets = [0,0];
				var server = 0;
				var search_params = new URLSearchParams(window.location.search);
				var player_0 = search_params.get('p1');
				var player_1 = search_params.get('p2');
				var title = search_params.get('title');
				var RULES = MATCH_TYPES[0];
				var MAX_SETS = RULES == MATCH_TYPES[0] ? 3 : 5;
				var MAX_WON_SETS = RULES == MATCH_TYPES[0] ? 2 : 3;
				$("#player-0-name").html(player_0);
				$("#player-1-name").html(player_1);	
				$("#match-rules").html(RULES);	
				$("#match-name").html(title);
				var update_clock = function(){
					var n = Date.now();
					var d = new Date(n);
					var e = n-START;
					var z = new Date(e);

					$("#elapsed-time").html(z.toLocaleTimeString("en-GB",{
						timeZone:"UTC",
						second:"2-digit",
						minute:"2-digit",
						hour:"2-digit",
						hour12:false,
						hourCycle:"h23"
					}));
					$("#match-datetime").html(d.toLocaleString("en-NZ",{
						weekday:"short",
						second:"2-digit",
						minute:"2-digit",
						hour:"2-digit",
						day:"2-digit",
						month:"2-digit",
						year:"2-digit",
						hour12:false,
					}));
				};
				setInterval(update_clock,1000);
				/*
				* a : player points before scoring
				* b : opponent points before scoring
				* t: tie break
				*/
				function getPointResults(a,b,t){
					var d = a+(t*1) - b;
					var x = t == true ? 6 : 3;
					var g = (d >= 2 && a >= x);
					var s = false;
					if(g == true) return {a:0,b:0,c:0,d:0,t:false,g,s:true};
					if(t == true){
						++a;
						s = ((a+b)%2) == 1;
						return {a,b,c:a,d:b,t,g,s};
					} 
					switch(a){
						case 3:
							switch(b){
								case 3:
									a = 4;
									break;
								case 4:
									b = 3;
									break;
								default:
									return {a:0,b:0,c:0,d:0,t:false,g:true,s:true};
							}
							break;
						case 4: 
								return {a:0,b:0,c:0,d:0,t:false,g:true,s:true};
						default:
							++a;
					}
					var c = CALLS[a];
					var d = CALLS[b];
					return {a,b,c,d,t,g,s};
				}

				function getGameResults(a,b,r,z){
					++a;
					var v  = ((a-b) >= 2 && a >= 6);
					var t = false;
					if(v == true) return {a,b,t,s:true};
					switch(r){
						case 'sd':
						case 'au':
						case 'us':
							t = a == 6 && b == 6;
							if(t == true) return {a,b,t,s:false};
							if(a == 7) return {a,b,t,s:true};
							return {a,b,t,s:false};
						case 'wb':
							t = (a == 6 && b == 6 && z < 4) || (a == 12 && b == 12 && z == 4);
							if(t == true) return {a,b,t,s:false};
							if(a == 13) return {a,b,t,s:true};
							return {a,b,t,s:false};
						case 'rg':
							t = (a == 6 && b == 6 && z < 4);
							if(t == true) return {a,b,t,s:false};
							return {a,b,t,s:false};
						default:
							t = (a == 6 && b == 6 && z < 4);
							if(t == true) return {a,b,t,s:false};
							return {a,b,t,s:false};
					}
				}

				function rotateRules(){
					if(game_over == true) return;
					var i = MATCH_TYPES.indexOf(RULES)+1;
					if(i == MATCH_TYPES.length) i = 0;
					RULES = MATCH_TYPES[i];
					MAX_SETS = RULES == MATCH_TYPES[0] ? 3 : 5;
					MAX_WON_SETS = RULES == MATCH_TYPES[0] ? 2 : 3;
					$("#match-rules").html(RULES);	
				}
				
				function switchService(){
					served = server;
					server = server == 0 ? 1 : 0;
					var serve_sign = tie_break == true ? "T" : "*";
					$("#player-"+server+"-turn").html(serve_sign);	
					$("#player-"+served+"-turn").html("");
				}

				var point = function(player){
					if(game_over == true) return;
					var opponent = player == 0 ? 1 : 0;
					var point_results = getPointResults(player_points[player],player_points[opponent],tie_break);
					var new_game = point_results.g;
					player_points[player] = point_results.a;
					player_points[opponent] = point_results.b;
					tie_break = point_results.t;
					$("#player-"+player+"-game").html(point_results.c);
					$("#player-"+opponent+"-game").html(point_results.d);
					//GAME
					if(new_game == true){
						var game_results = getGameResults(player_games[player],player_games[opponent],RULES,current_set);
						player_games[player] = game_results.a;
						tie_break = game_results.t;
						$("#player-"+player+"-set-"+current_set).html(game_results.a);
						var new_set = game_results.s;
						if(new_set == true){
							tie_break = false;
							player_sets[player] +=1
							if(player_sets[player] == MAX_WON_SETS){
								$("#player-"+player+"-turn").html("W");	
								$("#player-"+opponent+"-turn").html("");
								game_over = true;
								return;
							}else{
								current_set +=1;
								player_games[player] = 0;
								player_games[opponent] = 0;
								$("#player-"+player+"-set-"+current_set).html(player_games[player]);
								$("#player-"+opponent+"-set-"+current_set).html(player_games[opponent]);
							}
						}
					}
					//SERVICE
					if(point_results.s == true){
						switchService();
					}
				}

				$("#player-0-game").click(function(){
					point(0);
				});
				$("#player-1-game").click(function(){
					point(1);
				});
				$("#match-rules").click(function(){
					rotateRules();
				});
				$("#elapsed-time").click(function(){
					START = Date.now();
				});
				$("#service").click(function(){
					switchService();
				});
			});
		</script>
		<style>
			@import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
			body,html{
				background:#005500;
				color:#FFCC00;
				font-family:'VT323'!important;
				font-size:120pt;
				text-transform:uppercase;
				user-select:none!important;
				margin:0px;
				padding:0px;
				width:100vw;
				height:100vh;
			}
			table{
				border-collapse:collapse;
				width:100vw;
				height:100vh;
				padding:0px;
				margin:0px;
				border:none;
			}
			table .green td{
				border: #050 5px solid;
			}
			table * td{
				text-align:center;
			}
			.purple{
				color:white;
				background-color:#306;
			}
			.black{
				color:white;
				background-color:black;
			}
			.gold{
				color:#050;
				background-color:#FC0;
			}
			.green{
				color:#FC0;
				background-color:#050;
			}
			.gold-black{
				color:#FC0;
				background-color:#000;
			}
			.player-name{
				text-align:left;
			}
			.digits{
				width:8.4%!important;
			}
		</style>
  </head>
  <body>
		<table>
			<tbody>
				<tr class="purple">
					<td id="match-name" colspan="9">
					</td>
				</tr>
				<tr class="black">
					<td class="player-name gold-black">
						<span id="match-rules"></span>
						<span id="elapsed-time"></span>
					</td>
					<td class="digits gold-black" id="service">
						S
					</td>
					<td class="digits">
						P
					</td>
					<td class="digits">
						1
					</td>
					<td class="digits">
						2
					</td>
					<td class="digits">
						3
					</td>
					<td class="digits">
						4
					</td>
					<td class="digits">
						5
					</td>
				</tr>
				<tr id="player-0">
					<td id="player-0-name" class="player-name">
					</td>
					<td id="player-0-turn">
*
					</td>
					<td id="player-0-game" class="game gold">
0
					</td>
					<td id="player-0-set-0">
0
					</td>
					<td id="player-0-set-1">
					</td>
					<td id="player-0-set-2">
					</td>
					<td id="player-0-set-3">
					</td>
					<td id="player-0-set-4">
					</td>
				</tr>
				<tr id="player-1">
					<td id="player-1-name" class="player-name">
					</td>
					<td id="player-1-turn">
					</td>
					<td id="player-1-game" class="game gold">
0
					</td>
					<td id="player-1-set-0">
0
					</td>
					<td id="player-1-set-1">
					</td>
					<td id="player-1-set-2">
					</td>
					<td id="player-1-set-3">
					</td>
					<td id="player-1-set-4">
					</td>
				</tr>
				<tr>
					<td id="match-datetime" class="black" colspan="9">
						LOADING DATE
					</td>
				</tr>
			</tbody>
		</table>
  </body>
</html>
